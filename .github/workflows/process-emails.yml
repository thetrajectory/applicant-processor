name: 🔥 Process Applicant Emails

on:
  schedule:
    # Run every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches: [ main ]
    paths: [ 'src/**' ]

env:
  NODE_VERSION: '18'
  TIMEOUT_MINUTES: 25

jobs:
  process-emails:
    name: 📧 Process Latest Emails
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        
      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: 📦 Install Dependencies
        run: npm ci
        
      - name: 🔧 Setup Environment
        run: |
          echo "WORKFLOW_RUN_ID=${{ github.run_id }}" >> $GITHUB_ENV
          echo "WORKFLOW_RUN_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV
          
      - name: 🚀 Process Applicant Emails
        env:
          # Supabase Configuration
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          
          # OpenAI Configuration
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          
          # Google Services Configuration
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          GMAIL_USER_EMAIL: ${{ secrets.GMAIL_USER_EMAIL }}
          
          # Application Configuration
          BATCH_SIZE: ${{ vars.BATCH_SIZE || '50' }}
          MAX_EMAIL_AGE_DAYS: ${{ vars.MAX_EMAIL_AGE_DAYS || '7' }}
          DEBUG_MODE: ${{ vars.DEBUG_MODE || 'false' }}
          
        run: node src/main.js
        
      - name: 📊 Upload Processing Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: processing-logs-${{ github.run_id }}
          path: logs/
          retention-days: 7
          
      - name: 📈 Upload Processing Stats
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: processing-stats-${{ github.run_id }}
          path: stats.json
          retention-days: 30
          
      - name: 🚨 Notify on Failure
        if: failure()
        run: |
          echo "::error::Email processing failed in run ${{ github.run_id }}"
          echo "Check the logs for more details"

  # Optional: Health check job
  health-check:
    name: 🏥 System Health Check
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        
      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: 📦 Install Dependencies
        run: npm ci
        
      - name: 🔍 Run Health Checks
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          GMAIL_USER_EMAIL: ${{ secrets.GMAIL_USER_EMAIL }}
        run: node src/health-check.js