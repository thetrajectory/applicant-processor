name: Process Applicants with Message Tracking

on:
  schedule:
    # Run every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Number of emails to process'
        required: false
        default: '100'
      max_age_days:
        description: 'Maximum email age in days'
        required: false
        default: '7'
      dry_run:
        description: 'Run in dry-run mode (no actual changes)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  process-applicants:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run health check
      env:
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
        GOOGLE_SHEET_ID: ${{ vars.GOOGLE_SHEET_ID }}
        GOOGLE_DRIVE_FOLDER_ID: ${{ vars.GOOGLE_DRIVE_FOLDER_ID }}
        SUPABASE_URL: ${{ vars.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        BATCH_SIZE: ${{ github.event.inputs.batch_size || '100' }}
        MAX_EMAIL_AGE_DAYS: ${{ github.event.inputs.max_age_days || '7' }}
        DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        DEBUG_MODE: 'false'
        WORKFLOW_RUN_ID: ${{ github.run_id }}
      run: npm run health

    - name: Process applicant emails
      env:
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
        GOOGLE_SHEET_ID: ${{ vars.GOOGLE_SHEET_ID }}
        GOOGLE_DRIVE_FOLDER_ID: ${{ vars.GOOGLE_DRIVE_FOLDER_ID }}
        SUPABASE_URL: ${{ vars.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        BATCH_SIZE: ${{ github.event.inputs.batch_size || '100' }}
        MAX_EMAIL_AGE_DAYS: ${{ github.event.inputs.max_age_days || '7' }}
        DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        DEBUG_MODE: 'false'
        WORKFLOW_RUN_ID: ${{ github.run_id }}
      run: npm start

    - name: Upload processing logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: processing-logs-${{ github.run_id }}
        path: |
          logs/
          stats.json
        retention-days: 30

    - name: Upload stats as artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: processing-stats-${{ github.run_id }}
        path: stats.json
        retention-days: 7

    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          console.log(`‚ùå Applicant processing failed. Check logs: ${runUrl}`);