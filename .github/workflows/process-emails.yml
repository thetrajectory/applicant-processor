name: üî• Process Applicant Emails

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:
    inputs:
      debug_mode:
        description: "Enable debug mode"
        required: false
        default: "false"
        type: boolean
      run_health_check:
        description: "Run health check only"
        required: false
        default: "false"
        type: boolean
  push:
    branches: [main]
    paths: ["src/**"]

env:
  NODE_VERSION: "18"
  TIMEOUT_MINUTES: 25

jobs:
  process-emails:
    name: üìß Process Latest Emails
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: üì¶ Install Dependencies
        run: npm ci

      - name: üîç Debug Credentials
        if: github.event.inputs.debug_mode == 'true'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          GMAIL_USER_EMAIL: ${{ secrets.GMAIL_USER_EMAIL }}
        run: node src/debug-credentials.js

      - name: üè• Health Check Only
        if: github.event.inputs.run_health_check == 'true'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          GMAIL_USER_EMAIL: ${{ secrets.GMAIL_USER_EMAIL }}
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
        run: node src/health-check.js

      - name: üöÄ Process Applicant Emails
        if: github.event.inputs.run_health_check != 'true'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          GMAIL_USER_EMAIL: ${{ secrets.GMAIL_USER_EMAIL }}
          BATCH_SIZE: ${{ vars.BATCH_SIZE || '50' }}
          MAX_EMAIL_AGE_DAYS: ${{ vars.MAX_EMAIL_AGE_DAYS || '7' }}
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || vars.DEBUG_MODE || 'false' }}
        run: node src/main.js

      - name: üìä Upload Processing Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: processing-logs-${{ github.run_id }}
          path: logs/
          retention-days: 7
