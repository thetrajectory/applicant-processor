name: üî• Process Applicant Emails

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:
    inputs:
      debug_mode:
        description: "Enable debug mode"
        required: false
        default: "false"
        type: boolean
  push:
    branches: [main]
    paths: ["src/**"]

env:
  NODE_VERSION: "18"
  TIMEOUT_MINUTES: 25

jobs:
  process-emails:
    name: üìß Process Latest Emails
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: üì¶ Install Dependencies
        run: npm ci

      - name: üîç Debug Google Credentials Raw
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        run: |
          echo "=== GOOGLE CREDENTIALS DEBUG ==="
          echo "Length: ${#GOOGLE_CREDENTIALS}"
          echo "First 200 chars: ${GOOGLE_CREDENTIALS:0:200}"
          echo "Last 200 chars: ${GOOGLE_CREDENTIALS: -200}"
          echo ""

          # Try to parse as JSON
          if echo "$GOOGLE_CREDENTIALS" | jq . > /dev/null 2>&1; then
            echo "‚úÖ Valid JSON detected"
            echo "client_email: $(echo "$GOOGLE_CREDENTIALS" | jq -r '.client_email // "MISSING"')"
            echo "project_id: $(echo "$GOOGLE_CREDENTIALS" | jq -r '.project_id // "MISSING"')"
            echo "client_id: $(echo "$GOOGLE_CREDENTIALS" | jq -r '.client_id // "MISSING"')"
          else
            echo "‚ùå Invalid JSON format"
            echo "This explains why client_email is undefined!"
          fi

      - name: üöÄ Process Applicant Emails
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          GMAIL_USER_EMAIL: ${{ secrets.GMAIL_USER_EMAIL }}
          BATCH_SIZE: ${{ vars.BATCH_SIZE || '50' }}
          MAX_EMAIL_AGE_DAYS: ${{ vars.MAX_EMAIL_AGE_DAYS || '7' }}
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || vars.DEBUG_MODE || 'false' }}
        run: node src/main.js

      - name: üìä Upload Processing Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: processing-logs-${{ github.run_id }}
          path: logs/
          retention-days: 7
